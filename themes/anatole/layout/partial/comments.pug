if theme.duoshuo
    a#comments
    .ds-thread(data-thread-key=page.path, data-title=page.title, data-url=page.permalink, data-author-key='1')
    script.
        var duoshuoQuery = {short_name:"#{theme.duoshuo}"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();


if theme.disqus
    a#comments
    #disqus_thread
    script.
        var disqus_shortname = '#{theme.disqus}';
        var disqus_identifier = '#{page.path}';
        var disqus_title = '#{page.title}';
        var disqus_url = '#{config.url}/#{page.path}';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    script(id='dsq-count-scr' src='//#{theme.disqus}.disqus.com/count.js' async)

if theme.gentie
    a#comments
    #cloud-tie-wrapper.cloud-tie-wrapper
    script(src='https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js')
    script.
        var cloudTieConfig = { url: document.location.href, sourceId: '#{page.path}', productKey: '#{theme.gentie}', target: 'cloud-tie-wrapper' };var yunManualLoad = true;Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);

if theme.youyan
    a#comments
    #youyan_thread(class='post')
    script.
        (function() {

            var YYDiv = document.createElement('div');
            YYDiv.id = 'uyan_frame';
            document.getElementById('youyan_thread').appendChild(YYDiv);

            var YYScript = document.createElement('script');
            YYScript.type = 'text/javascript';
            YYScript.async = true;
            YYScript.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//v2.uyan.cc/code/uyan.js?uid=' + '#{theme.youyan}';
            YYScript.charset = 'UTF-8';
            document.getElementById('youyan_thread').appendChild(YYScript);

        })();

if theme.valine
    if theme.valine.enable == true
        a#comments
        #vcomments(style="margin:0 30px;")
        
        //- 使用新版 Valine 1.5.3（已内置 LeanCloud SDK）
        script.
          // 动态加载 Valine
          (function() {
            // 配置对象
            var config = {
              el: '#vcomments',
              appId: '#{theme.valine.appid}',
              appKey: '#{theme.valine.appkey}',
              // 关键：必须添加 serverURLs
              serverURLs: '#{theme.valine.serverURLs || "https://zdn4s5p4.lc-cn-n1-shared.com"}',
              notify: #{theme.valine.notify} || false,
              verify: #{theme.valine.verify} || false,
              placeholder: '#{theme.valine.placeholder}',
              path: window.location.pathname,
              avatar: '#{theme.valine.avatar}',
              visitor: true,
              highlight: true,
              recordIP: true
            };
            
            // 加载 Valine
            function loadValine() {
              // 检查是否已加载
              if (typeof Valine !== 'undefined') {
                initValine();
                return;
              }
              
              // 使用官方 CDN
              var script = document.createElement('script');
              script.src = 'https://cdn.jsdelivr.net/npm/valine@1.5.3/dist/Valine.min.js';
              script.async = true;
              
              script.onload = function() {
                console.log('Valine 1.5.3 加载成功');
                setTimeout(initValine, 100);
              };
              
              script.onerror = function() {
                console.warn('主 CDN 失败，尝试备用源');
                var backupScript = document.createElement('script');
                backupScript.src = 'https://unpkg.com/valine@1.5.3/dist/Valine.min.js';
                backupScript.onload = initValine;
                document.head.appendChild(backupScript);
              };
              
              document.head.appendChild(script);
            }
            
            function initValine() {
              if (typeof Valine === 'undefined') {
                console.error('Valine 未加载成功');
                return;
              }
              
              try {
                new Valine(config);
                console.log('Valine 初始化成功');
              } catch (error) {
                console.error('Valine 初始化失败:', error);
              }
            }
            
            // 页面加载完成后执行
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', loadValine);
            } else {
              loadValine();
            }
          })();
